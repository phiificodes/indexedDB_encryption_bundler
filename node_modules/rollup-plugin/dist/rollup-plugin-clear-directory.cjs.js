'use strict';

const fs = require('fs');

function getType(data) {
  return Object.prototype.toString.call(data)
}

function removeAllFiles(directory) {
  fs.readdir(directory, (err, files) => {
    if (files) {
      files.forEach(file => {
        const filepath = directory+'/'+file;
        if (fs.statSync(filepath).isDirectory()) {
          removeAllFiles(filepath);
          fs.rmdirSync(filepath); // delete empty directory
        } else {
          fs.unlinkSync(filepath); // delete file
        }
      });
    }
    if (fs.existsSync(directory)) {
      fs.rmdirSync(directory);
    }
  });

}

function clearPlugin(clearOptions) {
  return {
    name: 'clear-plugin',
    load(options) {
      const prefix = process.cwd();
      const output = clearOptions.targets;
      if (getType(output) === '[object Array]') {
        output.forEach(one => {
          const direct = prefix + '/' + one;
          direct && removeAllFiles(direct);
        });
      }
      return null
    },
  }
}

module.exports = clearPlugin;
